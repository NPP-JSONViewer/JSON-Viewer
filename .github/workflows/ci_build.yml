name: Build and test

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        build_configuration: [Release, Debug]
        build_platform: [Win32, x64, ARM64]

    steps:
      # Step 1: Check out the code from the repo
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
            submodules: recursive

      # Step 2: Prepare for build
      - name: Pre Build
        uses: microsoft/setup-msbuild@v2
      
      # Step 3: Build projects and unit test
      - name: Build code
        working-directory: src
        run: msbuild NppJSONViewer.sln /m /p:configuration="${{ matrix.build_configuration }}" /p:platform="${{ matrix.build_platform }}" /p:PlatformToolset="v143"

      # Step 4: Upload build binary artifacts for deployment
      - name: Archive binaries artifacts
        uses: actions/upload-artifact@v4
        with:
            name: NppJSONViewer_${{ matrix.build_platform}}_${{ matrix.build_configuration}}
            path: src\Build\Bin\${{ matrix.build_configuration}}\${{ matrix.build_platform}}\NPPJSONViewer.dll

      # Step 5: Upload build pdb artifacts
      - name: Archive symbols artifacts
        uses: actions/upload-artifact@v4
        with:
          name: NppJSONViewer_${{ matrix.build_platform}}_${{ matrix.build_configuration}}_pdb
          path: src\Build\Bin\${{ matrix.build_configuration}}\${{ matrix.build_platform}}\NPPJSONViewer.pdb

      # Step 6: Run unit tests for x86 and x64
      - name: Run unit tests
        if: matrix.build_platform == 'Win32' || matrix.build_platform == 'x64'
        run: |
          cd src\Build\Bin\${{ matrix.build_configuration }}\${{ matrix.build_platform }}
          ./UnitTest.exe

  upload-full-artifacts:
    # Trigger this job only after all 'build' jobs are complete
    needs: build
    runs-on: windows-latest
    strategy:
      fail-fast: true

    steps:
      # Step 8: Download all artifacts from all build jobs
      - name: Download Release Win32 binaries and PDBs
        uses: actions/download-artifact@v4
        with:
          path: all_artifacts/Release/win32
          pattern: NppJSONViewer_Win32_Rel*
          merge-multiple: true

      - name: Download Debug Win32 binaries and PDBs
        uses: actions/download-artifact@v4
        with:
          path: all_artifacts/Debug/win32
          pattern: NppJSONViewer_Win32_Deb*
          merge-multiple: true

      - name: Download Release x64 binaries and PDBs
        uses: actions/download-artifact@v4
        with:
          path: all_artifacts/Release/x64
          pattern: NppJSONViewer_x64_Rel*
          merge-multiple: true

      - name: Download Debug x64 binaries and PDBs
        uses: actions/download-artifact@v4
        with:
          path: all_artifacts/Debug/x64
          pattern: NppJSONViewer_x64_Deb*
          merge-multiple: true

      - name: Download Release ARM64 binaries and PDBs
        uses: actions/download-artifact@v4
        with:
          path: all_artifacts/Release/ARM64
          pattern: NppJSONViewer_ARM64_Rel*
          merge-multiple: true

      - name: Download Debug ARM64 binaries and PDBs
        uses: actions/download-artifact@v4
        with:
          path: all_artifacts/Debug/ARM64
          pattern: NppJSONViewer_ARM64_Deb*
          merge-multiple: true

      # Step 9: Upload full artifact
      - name: Upload full artifacts
        uses: actions/upload-artifact@v4
        with:
          name: NppJSONViewer_ALL
          path: all_artifacts\**
